# ‚úÖ –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –≥–æ—Ç–æ–≤–∞!

**–î–∞—Ç–∞:** 25 –Ω–æ—è–±—Ä—è 2025

---

## üéØ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. ‚úÖ –ú–æ–¥–µ–ª—å —Ç–æ–≤–∞—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞
–î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è –≤ `market.products`:
- `latitude` (DOUBLE) - —à–∏—Ä–æ—Ç–∞
- `longitude` (DOUBLE) - –¥–æ–ª–≥–æ—Ç–∞  
- `geo_location` (GEOMETRY POINT) - PostGIS —Ç–æ—á–∫–∞ –¥–ª—è –≥–µ–æ–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### 2. ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
–§–∞–π–ª: `migrations/versions/007_add_product_geolocation.sql`
- –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–ª–æ–Ω–∫–∏
- –°–æ–∑–¥–∞–Ω—ã –∏–Ω–¥–µ–∫—Å—ã (GIST –¥–ª—è geo_location, –æ–±—ã—á–Ω—ã–µ –¥–ª—è lat/lng)
- –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏

### 3. ‚úÖ API endpoint —Å–æ–∑–¥–∞–Ω
**GET** `/api/products/map/geojson`

–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
- `category_id` - —Ñ–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
- `in_stock` - —Ç–æ–ª—å–∫–æ –≤ –Ω–∞–ª–∏—á–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é true)
- `limit` - –º–∞–∫—Å–∏–º—É–º —Ç–æ–≤–∞—Ä–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1000)

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç GeoJSON —Å —Ç–æ–≤–∞—Ä–∞–º–∏:
```json
{
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [37.6173, 55.7558]
      },
      "properties": {
        "id": 123,
        "name": "–Ø–±–ª–æ–∫–∏",
        "price": 150.0,
        "image": "/uploads/...",
        "category_id": 1,
        "category_name": "–§—Ä—É–∫—Ç—ã",
        "category_icon": "üçé",
        "in_stock": true,
        "rating": 4.5
      }
    }
  ]
}
```

### 4. ‚úÖ –ö–∞—Ä—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞
–°—Ç—Ä–∞–Ω–∏—Ü–∞ `/map` —Ç–µ–ø–µ—Ä—å:
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ç–æ–≤–∞—Ä—ã —Å —Å–µ—Ä–≤–µ—Ä–∞ —á–µ—Ä–µ–∑ API
- –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –º–∞—Ä–∫–µ—Ä—ã —Å –∏–∫–æ–Ω–∫–∞–º–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (—ç–º–æ–¥–∑–∏)
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç popup —Å:
  - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —Ç–æ–≤–∞—Ä–∞
  - –ù–∞–∑–≤–∞–Ω–∏–µ–º
  - –¶–µ–Ω–æ–π
  - –ö–∞—Ç–µ–≥–æ—Ä–∏–µ–π
  - –ö–Ω–æ–ø–∫–æ–π "–ü–æ–¥—Ä–æ–±–Ω–µ–µ"
- –ö–∞—Å—Ç–æ–º–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã —Å hover —ç—Ñ—Ñ–µ–∫—Ç–æ–º

### 5. ‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
22 —Ç–æ–≤–∞—Ä–∞ –ø–æ–ª—É—á–∏–ª–∏ —Å–ª—É—á–∞–π–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —Ä–∞–¥–∏—É—Å–µ 10–∫–º –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –ú–æ—Å–∫–≤—ã

---

## üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Ä—Ç—ã —Ç–æ–≤–∞—Ä–æ–≤
1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3001/map
2. –£–≤–∏–¥–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã –Ω–∞ –∫–∞—Ä—Ç–µ —Å –∏–∫–æ–Ω–∫–∞–º–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
3. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –º–∞—Ä–∫–µ—Ä - –æ—Ç–∫—Ä–æ–µ—Ç—Å—è popup —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
4. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥—Ä–æ–±–Ω–µ–µ" - –ø–µ—Ä–µ–π–¥–µ—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ç–æ–≤–∞—Ä–∞

### API –∑–∞–ø—Ä–æ—Å—ã

**–í—Å–µ —Ç–æ–≤–∞—Ä—ã –Ω–∞ –∫–∞—Ä—Ç–µ:**
```bash
curl http://localhost:8000/api/products/map/geojson
```

**–¢–æ–ª—å–∫–æ —Ñ—Ä—É–∫—Ç—ã:**
```bash
curl "http://localhost:8000/api/products/map/geojson?category_id=1"
```

**–í—Å–µ —Ç–æ–≤–∞—Ä—ã (–≤–∫–ª—é—á–∞—è –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏):**
```bash
curl "http://localhost:8000/api/products/map/geojson?in_stock=false"
```

---

## üìù –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –Ω–æ–≤—ã–º —Ç–æ–≤–∞—Ä–∞–º

### –í—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ SQL:
```sql
UPDATE market.products 
SET 
    latitude = 55.7558,
    longitude = 37.6173,
    geo_location = ST_SetSRID(ST_MakePoint(37.6173, 55.7558), 4326)
WHERE id = 123;
```

### –ß–µ—Ä–µ–∑ Python:
```python
import psycopg2

conn = psycopg2.connect(
    host="localhost",
    database="edu_na_bazar",
    user="postgres",
    password="postgres"
)
cur = conn.cursor()

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
cur.execute("""
    UPDATE market.products 
    SET 
        latitude = %s,
        longitude = %s,
        geo_location = ST_SetSRID(ST_MakePoint(%s, %s), 4326)
    WHERE id = %s
""", (55.7558, 37.6173, 37.6173, 55.7558, product_id))

conn.commit()
```

### –ú–∞—Å—Å–æ–≤–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–ª—É—á–∞–π–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç:
```bash
cd backend
python apply_geo_migration.py
```

---

## üé® –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤

–ú–∞—Ä–∫–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —ç–º–æ–¥–∑–∏ –∏–∑ –ø–æ–ª—è `category.image`:
- üçé –§—Ä—É–∫—Ç—ã
- ü•ï –û–≤–æ—â–∏
- ü•õ –ú–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã
- ü•© –ú—è—Å–æ
- üçû –•–ª–µ–±
- ü•§ –ù–∞–ø–∏—Ç–∫–∏
- üç∞ –°–ª–∞–¥–æ—Å—Ç–∏
- üì¶ –î—Ä—É–≥–æ–µ

–ß—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –∏–∫–æ–Ω–∫—É –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:
```sql
UPDATE market.categories 
SET image = 'üçì' 
WHERE id = 1;
```

---

## üîç PostGIS –∑–∞–ø—Ä–æ—Å—ã

### –ù–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä—ã –≤ —Ä–∞–¥–∏—É—Å–µ 5–∫–º –æ—Ç —Ç–æ—á–∫–∏:
```sql
SELECT 
    id, 
    name, 
    ST_Distance(
        geo_location::geography,
        ST_SetSRID(ST_MakePoint(37.6173, 55.7558), 4326)::geography
    ) / 1000 as distance_km
FROM market.products
WHERE ST_DWithin(
    geo_location::geography,
    ST_SetSRID(ST_MakePoint(37.6173, 55.7558), 4326)::geography,
    5000  -- 5–∫–º –≤ –º–µ—Ç—Ä–∞—Ö
)
ORDER BY distance_km;
```

### –ù–∞–π—Ç–∏ –±–ª–∏–∂–∞–π—à–∏–µ 10 —Ç–æ–≤–∞—Ä–æ–≤:
```sql
SELECT 
    id, 
    name,
    latitude,
    longitude
FROM market.products
WHERE geo_location IS NOT NULL
ORDER BY geo_location <-> ST_SetSRID(ST_MakePoint(37.6173, 55.7558), 4326)
LIMIT 10;
```

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

- **–¢–æ–≤–∞—Ä–æ–≤ —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏:** 22
- **–¢–æ–≤–∞—Ä–æ–≤ –±–µ–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç:** –æ—Å—Ç–∞–ª—å–Ω—ã–µ
- **–ò–Ω–¥–µ–∫—Å—ã:** 3 (GIST + 2 –æ–±—ã—á–Ω—ã—Ö)
- **–§–æ—Ä–º–∞—Ç:** GeoJSON (—Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è –∫–∞—Ä—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö)

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–î–æ–±–∞–≤–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤—Å–µ–º —Ç–æ–≤–∞—Ä–∞–º** - —á–µ—Ä–µ–∑ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–æ–≤
2. **–§–∏–ª—å—Ç—Ä—ã –Ω–∞ –∫–∞—Ä—Ç–µ** - –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º, —Ü–µ–Ω–µ, —Ä–µ–π—Ç–∏–Ω–≥—É
3. **–ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤** - –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –±–ª–∏–∑–∫–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤
4. **–ü–æ–∏—Å–∫ –ø–æ —Ä–∞–¥–∏—É—Å—É** - "—Ç–æ–≤–∞—Ä—ã –≤ —Ä–∞–¥–∏—É—Å–µ 5–∫–º –æ—Ç –º–µ–Ω—è"
5. **–ú–∞—Ä—à—Ä—É—Ç—ã** - –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ –¥–æ —Ç–æ–≤–∞—Ä–∞

---

## ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!

–û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3001/map –∏ —É–≤–∏–¥–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã –Ω–∞ –∫–∞—Ä—Ç–µ! üó∫Ô∏è‚ú®
