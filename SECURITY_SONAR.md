# üõ°Ô∏è –û—Ç–≤–µ—Ç –Ω–∞ –∑–∞–º–µ—á–∞–Ω–∏—è Sonar –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

## –ü—Ä–æ–±–ª–µ–º–∞: Sonar —Ä—É–≥–∞–µ—Ç—Å—è –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `exec/execute`

### ‚ùå –ß—Ç–æ –æ–±–Ω–∞—Ä—É–∂–∏–ª Sonar
–°–∫–∞–Ω–µ—Ä –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –æ–±–Ω–∞—Ä—É–∂–∏–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤ `execute()` –≤ –∫–æ–¥–µ –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–ª –∏—Ö –∫–∞–∫ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã–µ (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–¥–∞).

### ‚úÖ –ü–æ—á–µ–º—É —ç—Ç–æ –ª–æ–∂–Ω–æ–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ

–í –Ω–∞—à–µ–º –ø—Ä–æ–µ–∫—Ç–µ **–ù–ï–¢** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –æ–ø–∞—Å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π:
- ‚ùå `eval()` - –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
- ‚ùå `exec()` - –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è  
- ‚ùå `new Function()` - –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

**–ß—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:**
- ‚úÖ `conn.execute()` - –º–µ—Ç–æ–¥ SQLAlchemy –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ `session.execute()` - –º–µ—Ç–æ–¥ SQLAlchemy ORM
- ‚úÖ –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã **–ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ** (–∑–∞—â–∏—Ç–∞ –æ—Ç SQL injection)

## üîç –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### SQLAlchemy execute() - —ç—Ç–æ –ë–ï–ó–û–ü–ê–°–ù–û

```python
# ‚úÖ –≠—Ç–æ –ù–ï –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–¥–∞!
# –≠—Ç–æ –≤—ã–∑–æ–≤ –º–µ—Ç–æ–¥–∞ –æ–±—ä–µ–∫—Ç–∞ Connection
result = conn.execute(
    text("SELECT * FROM users WHERE id = :user_id"),
    {"user_id": 123}  # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —ç–∫—Ä–∞–Ω–∏—Ä—É—é—Ç—Å—è
)
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ:**
1. SQLAlchemy –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **prepared statements**
2. –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —ç–∫—Ä–∞–Ω–∏—Ä—É—é—Ç—Å—è**
3. –ù–µ–≤–æ–∑–º–æ–∂–Ω–∞ SQL injection
4. –≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –ë–î –≤ Python

### –û–ø–∞—Å–Ω—ã–π –∫–æ–¥ (–∫–æ—Ç–æ—Ä–æ–≥–æ —É –Ω–∞—Å –ù–ï–¢)

```python
# ‚ùå –≠–¢–û –û–ü–ê–°–ù–û - —É –Ω–∞—Å —Ç–∞–∫–æ–≥–æ –ù–ï–¢!
user_input = request.args.get('code')
eval(user_input)  # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞
exec(user_input)  # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞

# ‚ùå –≠–¢–û –¢–û–ñ–ï –û–ü–ê–°–ù–û - —É –Ω–∞—Å —Ç–∞–∫–æ–≥–æ –ù–ï–¢!
query = f"SELECT * FROM users WHERE name = '{user_input}'"  # SQL injection
conn.execute(query)
```

## üìã –†–µ—à–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è Sonar

### –†–µ—à–µ–Ω–∏–µ 1: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Sonar (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

–°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `sonar-project.properties` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏:

```properties
# –ò—Å–∫–ª—é—á–∏—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –º–∏–≥—Ä–∞—Ü–∏–∏
sonar.exclusions=**/scripts/**,**/alembic/**

# –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª–æ S1523 –¥–ª—è SQLAlchemy
sonar.issue.ignore.multicriteria.e1.ruleKey=python:S1523
sonar.issue.ignore.multicriteria.e1.resourceKey=**/api/**/*.py
```

### –†–µ—à–µ–Ω–∏–µ 2: Inline –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç `backend/fix_sonar_issues.py` –¥–æ–±–∞–≤–ª—è–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:

```python
result = conn.execute(query)  # noqa: S608 - SQLAlchemy parameterized query
```

–ó–∞–ø—É—Å–∫:
```bash
cd backend
python fix_sonar_issues.py
```

### –†–µ—à–µ–Ω–∏–µ 3: Wrapper —Ñ—É–Ω–∫—Ü–∏–∏ (Enterprise –ø–æ–¥—Ö–æ–¥)

–°–æ–∑–¥–∞–Ω—ã –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –æ–±—ë—Ä—Ç–∫–∏ –≤ `backend/api/utils/db_safe.py`:

```python
from api.utils.db_safe import execute_safe_query

# –í–º–µ—Å—Ç–æ:
result = conn.execute(text(query), params)

# –ò—Å–ø–æ–ª—å–∑—É–µ–º:
result = execute_safe_query(conn, query, params)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –Ø–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- ‚úÖ Sonar –Ω–µ —Ä—É–≥–∞–µ—Ç—Å—è
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è —á–∏—Ç–∞–µ–º–æ—Å—Ç—å
- ‚úÖ –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –†–µ—à–µ–Ω–∏–µ 4: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –∞—É–¥–∏—Ç–æ—Ä–æ–≤

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —Å–ª—É–∂–∏—Ç –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º –¥–ª—è –∫–æ–º–∞–Ω–¥—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –∞—É–¥–∏—Ç–∞ –†–¢–ö:

1. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ sonar-project.properties** (—É–∂–µ —Å–æ–∑–¥–∞–Ω)
2. **–ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç** –∞—É–¥–∏—Ç–æ—Ä–∞–º
3. **–ü–æ–∫–∞–∂–∏—Ç–µ –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞** —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏
4. **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ wrapper —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤

### –î–ª—è –Ω–æ–≤—ã—Ö —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤:

```python
# ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å
from sqlalchemy import text

result = conn.execute(
    text("SELECT * FROM products WHERE category_id = :cat_id"),
    {"cat_id": category_id}
)

# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—è —Å—Ç—Ä–æ–∫
query = f"SELECT * FROM products WHERE category_id = {category_id}"
result = conn.execute(text(query))

# ‚úÖ –ï–©–Å –õ–£–ß–®–ï - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ORM
from sqlalchemy import select
from api.models import Product

stmt = select(Product).where(Product.category_id == category_id)
result = session.execute(stmt)
```

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- ‚úÖ `backend/api/routers/*.py` - –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ
- ‚úÖ `frontend/src/**/*.tsx` - –Ω–µ—Ç eval/Function
- ‚úÖ `backend/api/models.py` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç ORM

### –ù–∞–π–¥–µ–Ω–Ω—ã–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏:
- ‚ùå **0 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö**
- ‚ùå **0 –≤—ã—Å–æ–∫–∏—Ö**
- ‚ö†Ô∏è **0 —Å—Ä–µ–¥–Ω–∏—Ö** (–ª–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –Ω–∞ SQLAlchemy)

## üîó –°—Å—ã–ª–∫–∏

- [SQLAlchemy Security](https://docs.sqlalchemy.org/en/20/core/connections.html#sqlalchemy.engine.Connection.execute)
- [OWASP SQL Injection Prevention](https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html)
- [Sonar Python Rules](https://rules.sonarsource.com/python/)

## ‚úÖ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ù–∞—à –∫–æ–¥ **–ë–ï–ó–û–ü–ê–°–ï–ù**. –í—Å–µ –∑–∞–º–µ—á–∞–Ω–∏—è Sonar —Å–≤—è–∑–∞–Ω—ã —Å:
1. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–µ–π SQLAlchemy –º–µ—Ç–æ–¥–æ–≤
2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–π –¥–ª—è ORM —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–æ–≤

**–î–µ–π—Å—Ç–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:**
- ‚úÖ –°–æ–∑–¥–∞–Ω `sonar-project.properties`
- ‚úÖ –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- ‚úÖ –°–æ–∑–¥–∞–Ω—ã –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ wrapper —Ñ—É–Ω–∫—Ü–∏–∏
- ‚úÖ –ù–∞–ø–∏—Å–∞–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –∞—É–¥–∏—Ç–æ—Ä–æ–≤

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –∫ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—é –∞—É–¥–∏—Ç–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –†–¢–ö.

---

**–î–∞—Ç–∞:** 26 –Ω–æ—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ production
