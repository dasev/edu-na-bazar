name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
    
    - name: üê≥ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: üîê Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: üèóÔ∏è Build and push Backend
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/edu-na-bazar-backend:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: üèóÔ∏è Build and push Frontend
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        push: true
        tags: ${{ secrets.DOCKER_USERNAME }}/edu-na-bazar-frontend:latest
        build-args: |
          VITE_API_URL=${{ secrets.API_URL }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: üöÄ Deploy to Server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /opt/edu-na-bazar
          
          # –°–æ–∑–¥–∞—Ç—å backup –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
          echo "üì¶ Creating backup..."
          docker-compose exec -T postgres pg_dump -U postgres edu_na_bazar | gzip > /backups/pre_deploy_$(date +%Y%m%d_%H%M%S).sql.gz
          
          # –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥
          echo "üì• Pulling latest code..."
          git pull origin main
          
          # –û–±–Ω–æ–≤–∏—Ç—å –æ–±—Ä–∞–∑—ã
          echo "üê≥ Pulling Docker images..."
          docker-compose pull
          
          # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
          echo "üõë Stopping containers..."
          docker-compose down
          
          # –ó–∞–ø—É—Å—Ç–∏—Ç—å –Ω–æ–≤—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
          echo "üöÄ Starting new containers..."
          docker-compose up -d
          
          # –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
          echo "üîÑ Running migrations..."
          sleep 10  # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –ë–î
          docker-compose exec -T backend alembic upgrade head
          
          # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
          echo "‚úÖ Checking status..."
          docker-compose ps
          
          # –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã
          echo "üßπ Cleaning up..."
          docker system prune -af --volumes=false
          
          echo "üéâ Deployment completed!"
    
    - name: üîç Health Check
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
          sleep 15
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ API
          echo "üîç Checking API health..."
          curl -f http://localhost:8000/api/health || exit 1
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ Frontend
          echo "üîç Checking Frontend..."
          curl -f http://localhost || exit 1
          
          echo "‚úÖ All health checks passed!"
    
    - name: üìä Deployment Summary
      if: success()
      run: |
        echo "========================================="
        echo "‚úÖ Deployment Successful!"
        echo "========================================="
        echo "üåê Frontend: https://${{ secrets.SERVER_HOST }}"
        echo "üîå API: https://${{ secrets.SERVER_HOST }}/api/health"
        echo "üìÖ Time: $(date)"
        echo "üîñ Commit: ${{ github.sha }}"
        echo "üë§ Author: ${{ github.actor }}"
    
    - name: ‚ùå Deployment Failed
      if: failure()
      run: |
        echo "========================================="
        echo "‚ùå Deployment Failed!"
        echo "========================================="
        echo "Check logs above for details"
        exit 1
